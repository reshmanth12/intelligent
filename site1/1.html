<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thinking in Code 1</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: Arial, sans-serif;
    background: #eef2f3;
    margin-top: 20px;
  }

  .grid {
    position: relative;
    width: 315px;
    height: 315px;
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-template-rows: repeat(3, 100px);
    gap: 5px;
    background: #999;
    padding: 5px;
    transition: background 0.6s;
  }

  .cell {
    background: white;
    border: 2px solid #666;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cell.visited {
    background: #d3e5ff;
  }

  .cell.house-cell {
    background: #fff9c4;
    font-size: 32px;
    color: #e67e22;
  }

  .cell.reached {
    background: #b6ffb6 !important;
  }

  .boy {
    position: absolute;
    width: 60px;
    height: 60px;
    transition: top 0.6s ease, left 0.6s ease;
  }

  .boy.walking {
    animation: bounce 0.2s ease-in-out infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(0px); }
  }

  .controls { margin-top: 20px; }
  button { margin: 4px; padding: 8px 16px; cursor: pointer; }

  #commandsContainer {
    width: 360px;
    height: 200px;
    border: 2px solid #666;
    background: #fafafa;
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    overflow-y: auto;
    padding: 10px;
    transition: background 0.6s;
  }

  .command-cell {
    width: 320px;
    background: #ffffff;
    border: 1px solid #999;
    border-radius: 5px;
    margin: 4px 0;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    font-weight: bold;
    cursor: grab;
  }

  .command-cell.active {
    background: #d3e5ff;
    border-color: #007BFF;
  }

  .command-cell.dragging {
    opacity: 0.6;
    background: #f0f8ff;
  }

  .arrow {
    margin-right: 8px;
    color: #007BFF;
    visibility: hidden;
  }

  .command-cell.active .arrow {
    visibility: visible;
  }
</style>
</head>
<body>

<h2>Thinking in Code 1</h2>

<div class="grid" id="grid">
  <!-- 9 cells -->
  <div class="cell" id="cell-0"></div>
  <div class="cell" id="cell-1"></div>
  <div class="cell" id="cell-2"></div>
  <div class="cell" id="cell-3"></div>
  <div class="cell" id="cell-4"></div>
  <div class="cell" id="cell-5"></div>
  <div class="cell" id="cell-6"></div>
  <div class="cell" id="cell-7"></div>
  <div class="cell house-cell" id="cell-8"><i class="fa-solid fa-house"></i></div>

  <img src="boy_north.png" class="boy" id="boy" alt="Boy">
</div>

<div class="controls">
  <button onclick="addCommand('turnLeft')">Turn Left</button>
  <button onclick="addCommand('turnRight')">Turn Right</button>
  <button onclick="addCommand('moveForward')">Move Forward</button>
  <button onclick="addCommand('moveBackward')">Move Backward</button>
  <button onclick="runCommands()">â–¶ Run</button>
  <button onclick="reset()">ðŸ”„ Reset</button>
</div>

<div id="commandsContainer"></div>

<script>
const boy = document.getElementById('boy');
const grid = document.getElementById('grid');
const commandsContainer = document.getElementById('commandsContainer');
const cells = [...document.querySelectorAll('.cell')];

let commands = [];
let facing = 0;
let running = false;
let pos = { row: 1, col: 1 }; // Center on 3x3
const gridSize = 3;
const cellSize = 105;
const delay = 1000;
const boyImages = ["boy_north.png", "boy_east.png", "boy_south.png", "boy_west.png"];
const housePos = { row: 2, col: 2 };

// Initialize boy
function setBoyPosition() {
  boy.style.top = `${pos.row * cellSize + 25}px`;
  boy.style.left = `${pos.col * cellSize + 25}px`;
  boy.src = boyImages[facing];
}

// Highlight visited cell
function highlightPath() {
  const index = pos.row * gridSize + pos.col;
  cells[index].classList.add('visited');
}

// Add default commands at site open
window.onload = () => {
  const defaults = ["turnRight", "moveForward", "turnRight", "moveForward"];
  defaults.forEach(cmd => addCommand(cmd));
  setBoyPosition();
  highlightPath();
};

// Add command cell
function addCommand(cmd) {
  const cmdDiv = document.createElement('div');
  cmdDiv.className = 'command-cell';
  cmdDiv.draggable = true;
  cmdDiv.innerHTML = `<span class="arrow">âž¤</span> ${cmd}`;
  commandsContainer.appendChild(cmdDiv);
  commands.push(cmd);
  cmdDiv.addEventListener('dragstart', dragStart);
  cmdDiv.addEventListener('dragend', dragEnd);
}

let draggedItem = null;
function dragStart(e) {
  if (running) return e.preventDefault();
  draggedItem = e.target;
  e.target.classList.add('dragging');
}
function dragEnd(e) {
  e.target.classList.remove('dragging');
  const below = document.elementFromPoint(e.clientX, e.clientY);
  if (!commandsContainer.contains(below)) {
    e.target.remove();
    updateCommands();
  } else updateCommands();
  draggedItem = null;
}
commandsContainer.addEventListener('dragover', e => {
  e.preventDefault();
  const after = getDragAfterElement(commandsContainer, e.clientY);
  if (!after) commandsContainer.appendChild(draggedItem);
  else commandsContainer.insertBefore(draggedItem, after);
  updateCommands();
});
function getDragAfterElement(container, y) {
  const els = [...container.querySelectorAll('.command-cell:not(.dragging)')];
  return els.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) return { offset, element: child };
    else return closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function updateCommands() {
  commands = [...commandsContainer.children].map(c =>
    c.textContent.trim().replace('âž¤', '').trim()
  );
}

// Run sequence
async function runCommands() {
  if (!commands.length) return;
  running = true;
  grid.style.background = '#999';
  commandsContainer.style.background = '#fafafa';
  cells.forEach(c => c.classList.remove('reached'));
  const cmdCells = [...document.querySelectorAll('.command-cell')];
  for (let i = 0; i < commands.length; i++) {
    highlightCommand(cmdCells, i);
    await execute(commands[i]);
    await wait(delay);
  }
  checkDestination();
  running = false;
}

// Highlight active command being executed
function highlightCommand(cmdCells, idx) {
  cmdCells.forEach((c, i) => c.classList.toggle('active', i === idx));
}

// Command executor
function execute(cmd) {
  return new Promise(resolve => {
    boy.classList.add('walking');
    if (cmd === 'turnLeft') facing = (facing + 3) % 4;
    else if (cmd === 'turnRight') facing = (facing + 1) % 4;
    else if (cmd === 'moveForward') move(1);
    else if (cmd === 'moveBackward') move(-1);
    boy.src = boyImages[facing];
    setTimeout(() => {
      boy.classList.remove('walking');
      resolve();
    }, delay);
  });
}

// Move logic
function move(d) {
  if (facing === 0) pos.row -= d;
  if (facing === 1) pos.col += d;
  if (facing === 2) pos.row += d;
  if (facing === 3) pos.col -= d;
  pos.row = Math.max(0, Math.min(gridSize - 1, pos.row));
  pos.col = Math.max(0, Math.min(gridSize - 1, pos.col));
  setBoyPosition();
  highlightPath();
}

// Check house reached
function checkDestination() {
  if (pos.row === housePos.row && pos.col === housePos.col) {
    grid.style.background = '#b6ffb6';
    commandsContainer.style.background = '#b6ffb6';
    cells[8].classList.add('reached');
  } else {
    grid.style.background = '#ffb6b6';
    commandsContainer.style.background = '#ffb6b6';
  }
}

// Reset everything
function reset() {
  commands = [];
  commandsContainer.innerHTML = '';
  pos = { row: 1, col: 1 };
  facing = 0;
  cells.forEach(c => c.classList.remove('visited', 'reached'));
  grid.style.background = '#999';
  commandsContainer.style.background = '#fafafa';
  setBoyPosition();
  highlightPath();
  window.onload();
}

function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>

